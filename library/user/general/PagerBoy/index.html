<!DOCTYPE html>
<html>
<head>
    <title>PagerBoy Color</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta id="viewport-meta" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
       
    <style>
        /* === CORE VARIABLES (DEFAULT / DMG GRAY - Original PagerBoy) === */
        :root {
            --bg-color: #222;
            --chassis-color: #c0c0c0;
            --bezel-color: #777;
            --screen-bg: #9bbc0f;
            --screen-fg: #0f380f;
            --btn-dpad: #222;
            --btn-action: #b90040;
            --btn-meta: #333;
            --brand-color: #3020b0;
            --label-color: #3020b0;
            --power-led: #ff0000;
            --power-led-label: #666;
            --term-bg: #9bbc0f;
            --term-fg: #0f380f;
        }

        /* === THEME DEFINITIONS === */
        
        /* 1. DARK MODE (PagerBoy Dark / Stealth) */
        [data-theme="dark"] {
            --bg-color: #000;
            --chassis-color: #1a1a1a;
            --bezel-color: #333;
            --screen-bg: #000;
            --screen-fg: #00ff00;
            --btn-dpad: #111;
            --btn-action: #00ff00;
            --btn-meta: #222;
            --brand-color: #00ff00;
            --label-color: #00aa00;
            --power-led: #00ff00;
            --power-led-label: #00ff00;
            --term-bg: #000;
            --term-fg: #00ff00;
        }

        /* 2. BERRY (Fuchsia/Pink) - GBC Berry */
        [data-theme="berry"] {
            --bg-color: #2a0015;
            --chassis-color: #c71585;
            --bezel-color: #555;
            --btn-dpad: #1a1a1a;
            --btn-action: #1a1a1a;
            --brand-color: #fff;
            --label-color: #ffccdd;
            --power-led-label: #fff;
            --term-bg: #1a0010;
            --term-fg: #ff66aa;
        }

        /* 3. GRAPE (Purple) - GBC Grape */
        [data-theme="grape"] {
            --bg-color: #150a20;
            --chassis-color: #5c3d7a;
            --bezel-color: #444;
            --btn-dpad: #1a1a1a;
            --btn-action: #1a1a1a;
            --brand-color: #e0e0e0;
            --label-color: #ccbbdd;
            --power-led-label: #e0e0e0;
            --term-bg: #0a0510;
            --term-fg: #aa88cc;
        }

        /* 4. KIWI (Lime Green) - GBC Kiwi */
        [data-theme="kiwi"] {
            --bg-color: #152a00;
            --chassis-color: #9acd32;
            --bezel-color: #555;
            --btn-dpad: #1a1a1a;
            --btn-action: #1a1a1a;
            --brand-color: #1a3e00;
            --label-color: #1a3e00;
            --power-led-label: #1a3e00;
            --term-bg: #0a1500;
            --term-fg: #aaff00;
        }

        /* 5. DANDELION (Yellow) - GBC Dandelion */
        [data-theme="dandelion"] {
            --bg-color: #2a2500;
            --chassis-color: #fdd835;
            --bezel-color: #555;
            --btn-dpad: #1a1a1a;
            --btn-action: #1a1a1a;
            --brand-color: #005580;
            --label-color: #005580;
            --power-led-label: #005580;
            --term-bg: #151000;
            --term-fg: #ffdd00;
        }

        /* 6. TEAL (Cyan) - GBC Teal */
        [data-theme="teal"] {
            --bg-color: #001a1a;
            --chassis-color: #00a0a0;
            --bezel-color: #444;
            --btn-dpad: #1a1a1a;
            --btn-action: #1a1a1a;
            --brand-color: #fff;
            --label-color: #ccffff;
            --power-led-label: #fff;
            --term-bg: #001010;
            --term-fg: #00ffff;
        }

        /* 7. ATOMIC PURPLE */
        [data-theme="atomic"] {
            --bg-color: #0d0812;
            --chassis-color: #7b68ee;
            --bezel-color: #483d8b;
            --btn-dpad: #1a1a1a;
            --btn-action: #1a1a1a;
            --btn-meta: #2a2035;
            --brand-color: #e0d0f0;
            --label-color: #c0b0d0;
            --power-led-label: #e0d0f0;
            --term-bg: #0a0515;
            --term-fg: #bb99dd;
        }


        /* === FONTS & RESET === */
        @font-face { font-family: 'Material Icons'; font-style: normal; font-weight: 400; src: local('Material Icons'), local('MaterialIcons-Regular'), url(/MaterialIcons-Regular.ttf) format('truetype'); }
        @font-face { font-family: 'Steelfish'; font-style: normal; font-weight: 400; src: local('Steelfish'), url(/Steelfish.ttf) format('truetype'); }
        .material-icons { font-family: 'Material Icons',serif; font-weight: normal; font-style: normal; font-size: 24px; display: inline-block; line-height: 1; text-transform: none; letter-spacing: normal; word-wrap: normal; white-space: nowrap; direction: ltr; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; -moz-osx-font-smoothing: grayscale; font-feature-settings: 'liga'; }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; height: -webkit-fill-available; }
        
        body {
            background-color: var(--bg-color);
            font-family: sans-serif;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; min-height: -webkit-fill-available;
            color: #ccc;
            overflow-x: hidden;
            touch-action: pan-y;
            transition: background-color 0.4s ease;
        }

        /* === LOGIN OVERLAY === */
        #login {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: background-color 0.4s ease;
        }
        #login img { width: 80%; max-width: 300px; margin-bottom: 20px; }
        #login input { padding: 12px; font-size: 16px; margin: 10px 0; border-radius: 4px; border: 1px solid #555; background: #111; color: white; text-align: center; }
        #login button { padding: 12px 30px; font-size: 18px; cursor: pointer; background: #444; color: white; border: 1px solid #555; border-radius: 4px; font-family: 'Steelfish', sans-serif; }
        #login_error { color: #ff5555; margin-top: 15px; font-family: monospace; }

        /* === MAIN LAYOUT === */
        #app-container {
            display: none;
            width: 100%;
            flex-direction: column; align-items: center;
        }

        /* === MENU DIALOG (Matching Reference Design) === */
        dialog#menu-modal {
            background: #1a1a1a; 
            color: #fff; 
            border: none;
            padding: 0;
            border-radius: 12px; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            box-shadow: 0 20px 60px rgba(0,0,0,0.9); 
            width: 90%; max-width: 300px; 
            z-index: 20000;
            overflow: hidden;
        }
        dialog::backdrop { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        
        .modal-section {
            padding: 20px;
        }
        .modal-section-title {
            font-family: 'Steelfish', sans-serif;
            font-size: 18px;
            letter-spacing: 3px;
            text-align: center;
            color: #fff;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        .modal-divider {
            height: 1px;
            background: #333;
        }

        /* Color Shell Grid - 4x2 */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            justify-items: center;
        }
        .color-swatch {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.active {
            border-color: #fff;
            box-shadow: 0 0 12px rgba(255,255,255,0.4);
        }
        
        /* Swatch Colors */
        .swatch-original { background: linear-gradient(145deg, #d0d0d0 0%, #a0a0a0 100%); border: 2px solid #888; }
        .swatch-dark { background: linear-gradient(145deg, #222 0%, #0a0a0a 100%); border: 2px solid #444; }
        .swatch-berry { background: linear-gradient(145deg, #d81b60 0%, #a01050 100%); }
        .swatch-grape { background: linear-gradient(145deg, #7044a0 0%, #503080 100%); }
        .swatch-kiwi { background: linear-gradient(145deg, #a0d840 0%, #80b030 100%); }
        .swatch-dandelion { background: linear-gradient(145deg, #ffe040 0%, #d4b800 100%); }
        .swatch-teal { background: linear-gradient(145deg, #00b8b8 0%, #008888 100%); }
        .swatch-atomic { background: linear-gradient(145deg, #8b7acd 0%, #6a5aad 100%); }

        /* System Menu Buttons */
        .menu-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            padding: 14px 16px;
            background: #2a2a2a;
            border: none;
            border-radius: 6px;
            color: #ddd;
            font-size: 14px;
            font-family: sans-serif;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background 0.2s;
        }
        .menu-btn:last-child { margin-bottom: 0; }
        .menu-btn:hover { background: #333; }
        .menu-btn i { font-size: 20px; opacity: 0.8; }

        /* Close Button */
        .modal-close {
            display: block;
            width: calc(100% - 40px);
            margin: 0 auto 20px;
            padding: 12px;
            background: #333;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-family: 'Steelfish', sans-serif;
            font-size: 16px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .modal-close:hover { background: #444; }

        /* === CHASSIS === */
        .chassis {
            background-color: var(--chassis-color); 
            background-image: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(0,0,0,0.05) 100%);
            width: 100%; max-width: 500px;
            border-radius: 15px 15px 60px 15px;
            padding: 30px 25px 40px 25px;
            box-shadow: 
                12px 12px 24px rgba(0,0,0,0.6),
                inset 2px 2px 3px rgba(255,255,255,0.5),
                inset -5px -5px 15px rgba(0,0,0,0.2);
            margin: 20px auto;
            position: relative;
            display: flex; flex-direction: column;
            border: 1px solid rgba(0,0,0,0.3);
            transition: background-color 0.4s ease;
            overflow: hidden;
        }

        /* Ensure chassis content is above any background */
        .chassis > * {
            position: relative;
            z-index: 1;
        }

        /* POWER LED */
        .power-led-container {
            position: absolute;
            top: 12px;
            left: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 5;
        }
        .power-led {
            width: 8px; height: 8px; 
            background: var(--power-led);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--power-led);
            animation: led-pulse 2s ease-in-out infinite;
        }
        @keyframes led-pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        .power-led-label {
            font-size: 8px;
            color:  var(--power-led-label);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* SCREEN AREA */
        .screen-bezel {
            background-color: var(--bezel-color);
            border-radius: 10px 10px 40px 10px;
            padding: 0;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
            width: 100%; aspect-ratio: 1/1; max-height: 50vh;
            display: flex; justify-content: center; align-items: center;
            position: relative; overflow: hidden;
            border: 30px solid var(--bezel-color);
            margin-bottom: 10px;
            transition: border-color 0.4s ease, background-color 0.4s ease;
        }
        
        #screen-wrapper { 
            position: relative; z-index: 2; width: 100%; 
            height: auto; max-height: 100%; object-fit: contain; 
            background: transparent; 
            box-shadow: 0 0 25px rgba(0,0,0,0.9); 
        }
        #pager { width: 100%; height: auto; display: block; image-rendering: auto; }
        #blur-bg-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; filter: blur(25px) brightness(0.6) saturate(1.2); 
            z-index: 1; opacity: 0.8; transform: scale(1.5); 
        }

        #pager_error {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: monospace; z-index: 10;
        }
        #screen_retry { background: #ccc; color: black; border: none; padding: 5px 10px; margin-top: 10px; cursor: pointer; }

        /* BRANDING */
        .brand {
            font-family: 'Steelfish', sans-serif; 
            font-style: italic; font-weight: bold; font-size: 32px;
            color: var(--brand-color); text-align: right;
            margin-bottom: 5px; margin-top: 5px; margin-right: 5px;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.15);
            letter-spacing: 2px;
            transition: color 0.4s ease;
        }
        .brand .color-text {
            font-style: italic;
            font-size: 26px;
            margin-left: 4px;
        }
        .brand .color-text .c { color: #e60012; }
        .brand .color-text .o { color: #ff8c00; }
        .brand .color-text .l { color: #00a000; }
        .brand .color-text .o2 { color: #0060c0; }
        .brand .color-text .r { color: #8000a0; }
        
        /* Hide "Color" label on Default and Night themes */
        :root .brand .color-text,
        [data-theme="dark"] .brand .color-text {
            display: none;
        }
        
        /* Show "Color" label on all other themes */
        [data-theme="berry"] .brand .color-text,
        [data-theme="grape"] .brand .color-text,
        [data-theme="kiwi"] .brand .color-text,
        [data-theme="dandelion"] .brand .color-text,
        [data-theme="teal"] .brand .color-text,
        [data-theme="atomic"] .brand .color-text {
            display: inline;
        }

        /* CONTROLS AREA */
        .meta-buttons { 
            display: flex; justify-content: center; gap: 30px; 
            margin-top: 15px; margin-bottom: 20px; 
        }
        
        .controls-row {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 0 10px; margin-bottom: 10px;
        }

        /* D-PAD */
        .dpad { width: 130px; height: 130px; position: relative; }
        .dpad button {
            position: absolute; background-color: var(--btn-dpad); border: none; cursor: pointer;
            box-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            transition: background-color 0.4s ease;
        }
        .dpad button:active, .dpad button.pressed { box-shadow: inset 1px 1px 3px rgba(0,0,0,0.6); }
        
        .d-up { top: 0; left: 33.3%; width: 33.3%; height: 33.3%; border-radius: 4px 4px 0 0; }
        .d-down { bottom: 0; left: 33.3%; width: 33.3%; height: 33.3%; border-radius: 0 0 4px 4px; }
        .d-left { top: 33.3%; left: 0; width: 33.3%; height: 33.3%; border-radius: 4px 0 0 4px; }
        .d-right { top: 33.3%; right: 0; width: 33.3%; height: 33.3%; border-radius: 0 4px 4px 0; }
        .d-center { position: absolute; top: 33.3%; left: 33.3%; width: 33.3%; height: 33.3%; background: var(--btn-dpad); transition: background-color 0.4s ease; }
        .d-center::after { content:''; display:block; width: 80%; height: 80%; border-radius: 50%; background: radial-gradient(circle, #333 0%, #111 100%); margin: 10%; opacity: 0.5; }

        /* A/B BUTTONS */
        .ab-buttons { display: flex; gap: 15px; transform: rotate(-15deg); margin-right: 10px; align-items: flex-end; }
        .btn-wrapper { text-align: center; }
        .btn-round {
            width: 55px; height: 55px; border-radius: 50%;
            background-color: var(--btn-action); border: none;
            box-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            color: transparent; cursor: pointer;
            transition: background-color 0.4s ease;
        }
        .btn-round:active, .btn-round.pressed { box-shadow: inset 2px 2px 5px rgba(0,0,0,0.6); }
        .btn-label { font-family: sans-serif; font-weight: bold; font-size: 16px; color: var(--label-color); margin-top: 8px; letter-spacing: 1px; transition: color 0.4s ease; }

        /* START/SELECT */
        .pill-wrapper { display: flex; flex-direction: column; align-items: center; transform: rotate(-15deg); }
        .pill-btn {
            width: 70px; height: 24px; background: var(--btn-meta);
            border: none; border-radius: 12px; box-shadow: 1px 1px 3px rgba(0,0,0,0.6);
            cursor: pointer; margin-bottom: 5px;
            transition: background-color 0.4s ease;
        }
        .pill-btn:active, .pill-btn.pressed { transform: scale(0.95); box-shadow: inset 1px 1px 2px rgba(0,0,0,0.8); }
        .pill-label { font-size: 12px; font-weight: bold; color: var(--label-color); letter-spacing: 1px; transition: color 0.4s ease; }

        /* TERMINAL SECTION */
        #extras { width: 100%; max-width: 600px; padding: 0 10px; margin-bottom: 50px; }
        
        .terminal-actions {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            margin-bottom: 10px;
        }
        
        .term-key {
            background: var(--btn-meta); color: #ddd; border: none;
            padding: 15px 0; border-radius: 20px; font-family: 'Steelfish', sans-serif;
            font-size: 18px; cursor: pointer; text-align: center;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            transition: background-color 0.4s ease;
        }
        .term-key:active { background: #111; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.8); }

        #terminal-wrapper {
            width: 100%; height: 260px;
            background: var(--term-bg); border-radius: 4px;
            padding: 5px; overflow: hidden;
            transition: background-color 0.4s ease;
        }
        #terminal { width: 100%; height: 100%; }

        /* === MOBILE RESPONSIVE === */
        @media (max-width: 600px) {
            .chassis {
                width: 100%; max-width: 100%;
                margin: 0;
                border-radius: 0; box-shadow: none; border: none;
                min-height: 100svh; 
                padding: 40px 0 30px 0;
                justify-content: flex-start;
            }
            
            .screen-bezel { 
                border-radius: 10px;
                border-left: 0; border-right: 0; 
                border: 20px solid var(--bezel-color);
                border-width: 20px 0px 20px 0px ;
            }
            
            .power-led-container { top: 15px; left: 15px; }
            
            .brand { text-align: right; font-size: 28px; margin-right: 15px; }
            .brand .color-text { font-size: 22px; }
            
            .meta-buttons { margin-top: auto; margin-bottom: 30px; gap: 40px; }
            .controls-row { margin-bottom: 20px; padding: 0 15px; }
            
            .dpad { margin-left: 15px; }            
            .ab-buttons { margin-right: 10px; margin-top: 50px; }
            
            .terminal-actions { grid-template-columns: repeat(4, 1fr); margin-top: 20px; }
        }

        /* UTILITIES */
        [hidden] { display: none !important; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #archiveOverlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.55); z-index: 9999; }
        #archiveOverlay.show { display: flex; }
        #archiveToast { position: fixed; left: 50%; top: 18px; transform: translateX(-50%); background: rgba(25, 25, 25, 0.95); color: #fff; border: 1px solid rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 8px; z-index: 10000; display: none; }
        #archiveToast.show { display: block; }
    </style>
    
    <link rel="stylesheet" href="xterm.css" />
    <script src="xterm.js"></script>
</head>
<body>

    <div id="archiveOverlay" aria-hidden="true"><div class="spinner"></div></div>
    <div id="archiveToast"></div>

    <!-- Settings Menu Modal -->
    <dialog id="menu-modal">
        <div class="modal-section">
            <div class="modal-section-title">Color Shell</div>
            <div class="color-grid">
                <div class="color-swatch swatch-original active" data-theme="original" title="Original"></div>
                <div class="color-swatch swatch-dark" data-theme="dark" title="Dark"></div>
                <div class="color-swatch swatch-berry" data-theme="berry" title="Berry"></div>
                <div class="color-swatch swatch-grape" data-theme="grape" title="Grape"></div>
                <div class="color-swatch swatch-kiwi" data-theme="kiwi" title="Kiwi"></div>
                <div class="color-swatch swatch-dandelion" data-theme="dandelion" title="Dandelion"></div>
                <div class="color-swatch swatch-teal" data-theme="teal" title="Teal"></div>
                <div class="color-swatch swatch-atomic" data-theme="atomic" title="Atomic Purple"></div>
            </div>
        </div>
        
        <div class="modal-divider"></div>
        
        <div class="modal-section">
            <div class="modal-section-title">System</div>
            <button class="menu-btn" onclick="archiveLoot()">
                <i class="material-icons">archive</i>
                <span>Archive Loot</span>
            </button>
            <button class="menu-btn" onclick="location.href='/api/loot/zip'">
                <i class="material-icons">download</i>
                <span>Download Loot</span>
            </button>
            <button class="menu-btn" onclick="logout()">
                <i class="material-icons">logout</i>
                <span>Log Out</span>
            </button>
        </div>
        
        <button class="modal-close" onclick="document.getElementById('menu-modal').close()">CLOSE</button>
    </dialog>

    <div id="login">
        <img src="images/virtualpagertitle.png" alt="PagerBoy">
        <div id="loading_spinner" hidden><div class="spinner"></div></div>
        <div id="login_form">
            <label>PASSWORD</label><br>
            <input type="password" id="password" required><br>
            <button id="loginbutton">Start</button>
        </div>
        <div id="login_error"></div>
    </div>

    <div id="app-container">
        
        <div class="chassis">
            <div class="power-led-container">
                <div class="power-led"></div>
                <span class="power-led-label">Power</span>
            </div>
            
            <div class="screen-bezel">
                <img id="blur-bg-layer" src="">
                <div id="screen-wrapper">
                    <img id="pager" width="480" height="222">
                    <canvas id="pager_canvas" width="480" height="222" style="display:none;"></canvas>
                    <div hidden id="pager_error">
                        <span>NO SIGNAL</span>
                        <button id="screen_retry">RETRY</button>
                    </div>
                </div>
            </div>

            <div class="brand">
                PagerBoy
                <span class="color-text">
                    <span class="c">C</span><span class="o">O</span><span class="l">L</span><span class="o2">O</span><span class="r">R</span>
                </span>
            </div>

            <div class="meta-buttons">
                <div class="pill-wrapper">
                    <button class="pill-btn" onclick="document.getElementById('menu-modal').showModal()"></button>
                    <div class="pill-label">SELECT</div>
                </div>
                <div class="pill-wrapper">
                    <button class="pill-btn" onclick="activateTerminalMode()"></button>
                    <div class="pill-label">START</div>
                </div>
            </div>

            <div class="controls-row">
                <div class="dpad">
                    <div class="d-center"></div>
                    <button class="d-up" data-key="ArrowUp"></button>
                    <button class="d-left" data-key="ArrowLeft"></button>
                    <button class="d-right" data-key="ArrowRight"></button>
                    <button class="d-down" data-key="ArrowDown"></button>
                </div>
                
                <div class="ab-buttons">
                    <div class="btn-wrapper">
                        <button class="btn-round" data-key="Escape">B</button>
                        <div class="btn-label">B</div>
                    </div>
                    <div class="btn-wrapper" style="margin-top: -20px;">
                        <button class="btn-round" data-key="Enter">A</button>
                        <div class="btn-label">A</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="extras">
            <div class="terminal-actions">
                <button class="term-key" onclick="sendTermKey('\t')">TAB</button>
                <button class="term-key" onclick="sendTermKey('\x1b[A')">UP</button>
                <button class="term-key" onclick="sendTermKey('\x1b[B')">DOWN</button>
                <button class="term-key" onclick="sendTermKey('\x1b[D')">LEFT</button>
                <button class="term-key" onclick="sendTermKey('\x1b[C')">RIGHT</button>
                <button class="term-key" onclick="sendTermKey('\x1b')">ESC</button>
                <button class="term-key" onclick="sendTermKey('\x03')">CTRL+C</button>
                <button class="term-key" onclick="sendTermKey('\x0c')">CLEAR</button>
            </div>
            <div id="terminal-wrapper">
                <div id="terminal"></div>
            </div>
            <p style="text-align: center; color: #555; margin-bottom: 20px;">(Tap terminal to type)</p>
        </div>

    </div>

    <script>
        let login_ok = false, keyws, screenws, shellws, server_id = '';
        const SCREEN_WIDTH = 480, SCREEN_HEIGHT = 222, FB_STRIDE = SCREEN_WIDTH * 4;
        let currentTheme = 'original';

        // Terminal color themes for each shell color
        const terminalThemes = {
            original: { background: '#9bbc0f', foreground: '#0f380f', cursor: '#0f380f' },
            dark:     { background: '#000000', foreground: '#00ff00', cursor: '#00ff00' },
            berry:    { background: '#1a0010', foreground: '#ff66aa', cursor: '#ff66aa' },
            grape:    { background: '#0a0510', foreground: '#aa88cc', cursor: '#aa88cc' },
            kiwi:     { background: '#0a1500', foreground: '#aaff00', cursor: '#aaff00' },
            dandelion:{ background: '#151000', foreground: '#ffdd00', cursor: '#ffdd00' },
            teal:     { background: '#001010', foreground: '#00ffff', cursor: '#00ffff' },
            atomic:   { background: '#0a0515', foreground: '#bb99dd', cursor: '#bb99dd' }
        };

        // Terminal Setup
        const isMobile = window.innerWidth <= 600;
        const term = new Terminal({
            cols: isMobile ? 42 : 80, 
            rows: 24, 
            theme: terminalThemes.original,
            cursorBlink: true
        });

        // === THEME SYSTEM ===
        function setTheme(theme) {
            // Remove previous theme
            document.body.removeAttribute('data-theme');
            
            // Apply new theme (if not original)
            if (theme !== 'original') {
                document.body.setAttribute('data-theme', theme);
            }
            
            // Update active swatch
            document.querySelectorAll('.color-swatch').forEach(s => {
                s.classList.toggle('active', s.dataset.theme === theme);
            });
            
            // Update terminal colors
            const termTheme = terminalThemes[theme] || terminalThemes.original;
            term.options.theme = termTheme;
            document.getElementById('terminal-wrapper').style.background = termTheme.background;
            
            // Save preference
            currentTheme = theme;
            localStorage.setItem('pagerboy_theme', theme);
        }

        // Initialize color swatch click handlers
        function initThemeSelector() {
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    setTheme(swatch.dataset.theme);
                });
            });
        }

        function activateTerminalMode() { 
            document.getElementById('extras').scrollIntoView({ behavior: 'smooth' }); 
            term.focus(); 
        }

        // === API / LOGIN LOGIC ===
        function check_login() {
            const xhr = new XMLHttpRequest();
            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const response = JSON.parse(xhr.responseText);
                    server_id = response["serverid"];
                    if (!login_ok) {
                        document.getElementById('login').hidden = true;
                        document.getElementById('app-container').style.display = 'flex';
                        document.body.classList.add('logged-in');
                        
                        // Apply saved theme
                        const savedTheme = localStorage.getItem('pagerboy_theme') || 'original';
                        setTheme(savedTheme);
                        
                        connect();
                        login_ok = true;
                    }
                } else {
                    document.getElementById('login').hidden = false;
                    document.getElementById('app-container').style.display = 'none';
                    if (login_ok) { login_ok = false; close(); }
                }
                document.getElementById('loading_spinner').hidden = true;
                document.getElementById('login_form').hidden = false;
            };
            xhr.open('GET', '/api/api_ping');
            xhr.send();
        }

        function login() {
            const pw = document.getElementById('password');
            document.getElementById('loading_spinner').hidden = false;
            document.getElementById('login_form').hidden = true;
            
            const xhr = new XMLHttpRequest();
            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const response = JSON.parse(xhr.responseText);
                    const decoded = JSON.parse(atob(response['token'].split('.')[0]));
                    document.cookie = `AUTH_${decoded.ServerId}=${response['token']};path=/;samesite=strict;max-age=${60*60*12}`;
                    serverid = decoded.ServerId;
                    check_login();
                } else {
                    document.getElementById('loading_spinner').hidden = true;
                    document.getElementById('login_form').hidden = false;
                    document.getElementById('login_error').innerText = "Incorrect Password";
                }
            };
            const json = { "username": "root", "password": pw.value };
            xhr.open('POST', '/api/login');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(json));
        }

        function logout() {
            document.cookie = `AUTH_${server_id}=dead;path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT`;
            location.reload();
        }
        
        function archiveLoot() {
            document.getElementById('menu-modal').close();
            document.getElementById("archiveOverlay").classList.add("show");
            fetch("/api/loot/archive", { method: "POST" })
                .then(r => {
                    document.getElementById("archiveOverlay").classList.remove("show");
                    const t = document.getElementById("archiveToast");
                    t.textContent = r.ok ? "Loot Archived" : "Archive Failed";
                    t.classList.add("show");
                    setTimeout(() => t.classList.remove("show"), 2500);
                });
        }

        // === WEBSOCKETS ===
        function connect() {
            const pager = document.getElementById('pager');
            const pagerError = document.getElementById('pager_error');

            keyws = new WebSocket(`ws://${window.location.host}/api/pager/input/keys.ws`);
            
            screenws = new WebSocket(`ws://${window.location.host}/api/pager/display/screen.ws`);
            screenws.binaryType = "arraybuffer";
            screenws.onopen = () => { pagerError.hidden = true; };
            screenws.onmessage = (e) => renderRGBAFrame(new Uint8Array(e.data));
            screenws.onerror = () => { pagerError.hidden = false; };

            shellws = new WebSocket(`ws://${window.location.host}/api/terminal/openWs`);
            shellws.onopen = () => term.write("\r\n[connected]\r\n");
            shellws.onmessage = (e) => {
                if(typeof e.data === 'string') term.write(e.data);
                else if(e.data instanceof Blob) e.data.arrayBuffer().then(b => term.write(new Uint8Array(b)));
                else term.write(new Uint8Array(e.data));
            };
        }

        function renderRGBAFrame(bytes) {
            if (bytes.length < FB_STRIDE * SCREEN_HEIGHT) return;
            const canvas = document.getElementById("pager_canvas");
            const ctx = canvas.getContext("2d");
            const imgData = ctx.createImageData(SCREEN_WIDTH, SCREEN_HEIGHT);
            const dst = imgData.data;
            
            let di = 0;
            for (let y = 0; y < SCREEN_HEIGHT; y++) {
                const rowStart = y * FB_STRIDE;
                for (let x = 0; x < SCREEN_WIDTH; x++) {
                    const si = rowStart + x * 4;
                    dst[di] = bytes[si];
                    dst[di+1] = bytes[si+1];
                    dst[di+2] = bytes[si+2];
                    dst[di+3] = bytes[si+3];
                    di += 4;
                }
            }
            ctx.putImageData(imgData, 0, 0);
            const url = canvas.toDataURL("image/png");
            document.getElementById('pager').src = url;
            document.getElementById('blur-bg-layer').src = url;
        }

        function close() {
            if(keyws) keyws.close();
            if(screenws) screenws.close();
            if(shellws) shellws.close();
        }

        function sendTermKey(data) {
            if (shellws && shellws.readyState === WebSocket.OPEN) shellws.send(data);
            if (!('ontouchstart' in window)) term.focus();
        }

        // === INIT ===
        (function init() {
            check_login();
            initThemeSelector();
            
            document.getElementById("loginbutton").onclick = login;
            document.getElementById("password").onkeyup = e => { if (e.key === 'Enter') login(); };
            document.getElementById("screen_retry").onclick = connect;

            term.open(document.getElementById("terminal"));
            term.onData(d => sendTermKey(d));

            document.querySelectorAll('button[data-key]').forEach(btn => {
                const trigger = (e) => {
                    if (e.cancelable) e.preventDefault();
                    btn.classList.add('pressed');
                    setTimeout(() => btn.classList.remove('pressed'), 120);
                    if (keyws) keyws.send(btn.dataset.key);
                };
                btn.addEventListener('touchstart', trigger, {passive: false});
                btn.addEventListener('mousedown', trigger);
            });

            const SCROLL_KEYS = new Set(["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "Spacebar", " "]);
            document.addEventListener("keydown", (e) => {
                if (document.activeElement === document.body || document.activeElement.tagName === 'BUTTON') {
                    if (SCROLL_KEYS.has(e.key)) e.preventDefault();
                    if (keyws && !e.repeat) keyws.send(e.key);
                }
            });
            
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
        })();
    </script>
</body>
</html>